<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Smart AI Recommender</title>

    <!-- Modern Bootstrap 5 for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Custom Stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container-fluid h-100 d-flex justify-content-center align-items-center">
        <div class="col-md-8 col-xl-6 chat">
            <div class="card">
                <div class="card-header msg_head">
                    <div class="d-flex bd-highlight">
                        <div class="img_cont">
                            <img src="https://static.vecteezy.com/system/resources/previews/016/017/018/non_2x/ecommerce-icon-free-png.png" alt="Chatbot Avatar" class="rounded-circle user_img">
                            <span class="online_icon"></span>
                        </div>
                        <div class="user_info">
                            <span>Shop Smart AI</span>
                            <p>Ask me about our products!</p>
                        </div>
                    </div>
                </div>
                <div id="chat-log" class="card-body msg_card_body">
                    <!-- Initial welcome message -->
                    <div class="d-flex justify-content-start mb-4">
                        <div class="img_cont_msg">
                            <img src="https://static.vecteezy.com/system/resources/previews/016/017/018/non_2x/ecommerce-icon-free-png.png" alt="Bot Avatar" class="rounded-circle user_img_msg">
                        </div>
                        <div class="msg_cotainer">
                            Hi there! How can I help you find the perfect product today?
                            <span class="msg_time">Now</span>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <form id="message-form" class="input-group">
                        <input type="text" id="user-input" class="form-control type_msg" placeholder="Type your message..." autocomplete="off" required aria-label="Message Input">
                        <button type="submit" id="send-button" class="input-group-text send_btn" aria-label="Send Message">
                            <i class="fas fa-location-arrow"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery (slim version) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script>
        $(document).ready(function() {
            // Function to format the current time (e.g., 17:05)
            function getCurrentTime() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            }

            // Function to add a message to the chat log and scroll down
            function appendMessage(html) {
                const chatLog = $('#chat-log');
                chatLog.append(html);
                chatLog.scrollTop(chatLog[0].scrollHeight);
            }

            // Handle form submission
            $('#message-form').on('submit', function(event) {
                event.preventDefault(); // Prevent page reload

                const userInput = $('#user-input').val().trim();
                if (!userInput) return; // Don't send empty messages

                const currentTime = getCurrentTime();
                const userHtml = `
                    <div class="d-flex justify-content-end mb-4">
                        <div class="msg_cotainer_send">
                            ${userInput}
                            <span class="msg_time_send">${currentTime}</span>
                        </div>
                        <div class="img_cont_msg">
                            <img src="https://i.ibb.co/d5b84Xw/Untitled-design.png" alt="User Avatar" class="rounded-circle user_img_msg">
                        </div>
                    </div>`;

                appendMessage(userHtml);
                $('#user-input').val(''); // Clear the input field

                // Show a "typing..." indicator for the bot
                const typingIndicator = `
                    <div class="d-flex justify-content-start mb-4" id="typing-indicator">
                        <div class="img_cont_msg">
                            <img src="https://static.vecteezy.com/system/resources/previews/016/017/018/non_2x/ecommerce-icon-free-png.png" alt="Bot Avatar" class="rounded-circle user_img_msg">
                        </div>
                        <div class="msg_cotainer">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>`;
                appendMessage(typingIndicator);

                // Send the message to the Flask backend
                $.ajax({
                    type: "POST",
                    url: "/get", // Your Flask endpoint
                    data: { msg: userInput },
                    success: function(data) {
                        const botHtml = `
                            <div class="d-flex justify-content-start mb-4">
                                <div class="img_cont_msg">
                                    <img src="https://static.vecteezy.com/system/resources/previews/016/017/018/non_2x/ecommerce-icon-free-png.png" alt="Bot Avatar" class="rounded-circle user_img_msg">
                                </div>
                                <div class="msg_cotainer">
                                    ${data}
                                    <span class="msg_time">${getCurrentTime()}</span>
                                </div>
                            </div>`;
                        appendMessage(botHtml);
                    },
                    error: function() {
                        const errorHtml = `
                            <div class="d-flex justify-content-start mb-4">
                                <div class="img_cont_msg">
                                    <img src="https://static.vecteezy.com/system/resources/previews/016/017/018/non_2x/ecommerce-icon-free-png.png" alt="Bot Avatar" class="rounded-circle user_img_msg">
                                </div>
                                <div class="msg_cotainer">
                                    Sorry, something went wrong. Please try again.
                                    <span class="msg_time">${getCurrentTime()}</span>
                                </div>
                            </div>`;
                        appendMessage(errorHtml);
                    },
                    complete: function() {
                        // Remove the "typing..." indicator
                        $('#typing-indicator').remove();
                    }
                });
            });
        });
    </script>
</body>
</html>